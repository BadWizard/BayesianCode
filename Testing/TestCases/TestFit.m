classdef  TestFit < matlab.unittest.TestCase
    
    properties
        experiment
    end
    
    methods (TestMethodSetup)
        function createExperiment(testCase)
            concs=[3e-08];
            tres=[2.5e-05];
            tcrits=[0.0035];
            use_chs =[1];
            debug_on=0;
            fit_logspace=1;
            calc_hessian=1;
            datafiles={[getenv('P_HOME') '/Samples/Simulations/20000/test_1.scn']};
            modelfile=[getenv('P_HOME') '/Tools/Mechanisms/model_params_CS 1985_4.mat'];
            testCase.experiment = setup_experiment(tres,tcrits,concs,use_chs,debug_on,fit_logspace,calc_hessian,datafiles,modelfile);
        end
    end
    
    methods(Test)
        function testFit(testCase)
            fit=fit_experiment(testCase.experiment);
            
            %test likelihood
            testCase.verifyEqual(fit.likelihood,-39977.067229734268039,'AbsTol',sqrt(eps))
            
            %test parameters
            testParams={1.894008799454954e+03,50166.5732124815403949,5956.1950769773375214,48.8015597781170101,...
                55660.3354909404588398,85.4578379657354503,1515.0028410612299012,10052.6954842407249089,384907101.7667284607887268};
            testCase.verifyEqual(fit.parameters.values,testParams,'AbsTol',sqrt(eps))
            
            %test iterations
            testCase.verifyEqual(fit.iterations,796,'AbsTol',sqrt(eps))
            
            %test hessian
            testHessian = [ 0.0003369753336050 -0.0000125926464005 -0.0000106613633808 0.0013092997022022 -0.0000001306403929 0.0000468936425535 0.0000060718609955 0.0000096272273514 -0.0000000001517880;
                           -0.0000125926464005 0.0000005954122665 0.0000002192727504 -0.0000663681150210 0.0000000157426132 -0.0000069750212082 -0.0000001684219568 -0.0000000845429514 0.0000000000075510;
                           -0.0000106613633808 0.0000002192727504 0.0000510175771762 -0.0005738422101786 -0.0000015075903699 0.0006485744455974 0.0000319698082879 -0.0000070214028527 0.0000000000754446;
                            0.0013092997022022 -0.0000663681150210 -0.0005738422101786 0.2204981338180338 0.0000344147429171 -0.0378255821897022 -0.0035827361590822 0.0006846755342229 -0.0000000239421838;
                           -0.0000001306403929 0.0000000157426132 -0.0000015075903699 0.0000344147429171 0.0000001284638726 -0.0000538949010314 -0.0000029608060829 0.0000003468262928 -0.0000000000039062;
                            0.0000468936425535 -0.0000069750212082 0.0006485744455974 -0.0378255821897022 -0.0000538949010314 0.0385649358521675 0.0020883507620269 -0.0002771983347492 0.0000000047639617;
                            0.0000060718609955 -0.0000001684219568 0.0000319698082879 -0.0035827361590822 -0.0000029608060829 0.0020883507620269 0.0001976879410884 -0.0000120040381124 0.0000000002750082;
                            0.0000096272273514 -0.0000000845429514 -0.0000070214028527 0.0006846755342229 0.0000003468262928 -0.0002771983347492 -0.0000120040381124 0.0000068976501448 -0.0000000000883518;
                           -0.0000000001517880 0.0000000000075510 0.0000000000754446 -0.0000000239421838 -0.0000000000039062 0.0000000047639617 0.0000000002750082 -0.0000000000883518 0.0000000000000032];
            
            testCase.verifyEqual(fit.hessian,testHessian,'AbsTol',sqrt(eps))
            
        end
    end
    
    methods (TestMethodTeardown)
        function destroyExperiment(testCase)
            clear testCase.experiment
        end
    end
    
end

